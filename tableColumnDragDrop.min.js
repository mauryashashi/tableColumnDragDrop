angular.module("tableColumnDragDropModule",[]).directive("tableColumnDragDrop",function(){return{link:function(t,e,n){e.attr("draggable",!0),n.handle&&e.find(n.handle).length<1&&($handle=angular.element('<span class="handle"><i class="fa fa-caret-right"></i><i class="fa fa-caret-left"></i></span>'),e.append($handle)),n.handle&&e.find(n.handle)?e.find(n.handle).attr("style","cursor: e-resize;"):e.attr("style","cursor: e-resize;");var a,i,o=n.limit||50,l=0,r=!1,s=!1,d=!1;$(document).on("dragover",function(t){a=t.originalEvent.clientX,i=t.originalEvent.clientY});var f=function(t,e){for(var n in e)t=t.replace(new RegExp("{"+n+"}","g"),e[n]);return t},h=function(t){l=t.originalEvent.clientX-e.offset().left},c=function(t){d&&d.remove(),h(t),u(g())},g=function(){var t="",n=e.index()+1,a=e.closest("table").find("tr td:nth-child("+n+"):visible");a.addClass("ghost__data");var i=a.length;i>o&&(i=o);for(var l=0;l<i;l++){var r=$(a[l]);t+=f('<div class="{elemClass}" style="height: {height}px; width: {width}px;">{text}</div>',{elemClass:"ghost__td",height:r.outerHeight(),width:r.outerWidth(),text:r.html()})}return t},u=function(t){e.closest("table").before(f('<div class="ghost bg-warning" style="position: fixed;"><div style="zoom:80%">{ghostHtml}</div></div>',{ghostHtml:t})),d=$(".ghost");var n=e.offset();d.css("top",n.top-$(window).scrollTop()+e.outerHeight()),d.css("left",n.left)},v=function(){e.closest("table").find(".ghost__placeholder").removeClass("ghost__placeholder").removeAttr("width"),e.closest("table").find(".ghost__data").removeClass("ghost__data")};e.bind("mousedown",function(t){s=t.target}),e.bind("dragstart",function(t){if(void 0!==t.originalEvent.dataTransfer&&void 0!==t.originalEvent.dataTransfer.mozSourceNode&&t.originalEvent.dataTransfer.setData("application/node type",this),n.handle&&!$(s).hasClass(n.handle)&&!$(s).closest(n.handle).length)return!1;v(),e.addClass("ghost__placeholder").attr("width",e.outerWidth()),c(t)}),e.bind("drag",function(t){clearTimeout(r),r=setTimeout(function(){d&&d.css("left",a-l)},5)}),e.bind("dragend",function(t){d&&d.remove(),v(),s=!1});var m=!1,p=!1,b=function(t,n,a){if(t===m&&n===p)return!1;var i=e.closest("table").find(".ghost__placeholder").last(),o=e.closest("table").find("tbody td:nth-child("+n+")"),l=e.closest("table").find(".ghost__data"),r=o.length;if("right"===t){e.after(i);for(var s=1;s<r&&void 0!==l[s];s++)$(o[s]).after(l[s])}else if("left"===t){e.before(i);for(var d=1;d<r&&void 0!==l[d];d++)$(o[d]).before(l[d])}m=t,p=n,a&&(m=!1,p=!1)};e.bind("dragover",function(t){t.preventDefault(),clearTimeout(r),r=setTimeout(function(){var n=t.originalEvent.x>e.offset().left+e.width()/2?"right":"left";b(n,e.index()+1)},5)}),e.bind("drop",function(t){var n=t.originalEvent.x>e.offset().left+e.width()/2?"right":"left";b(n,e.index()+1,!0)})}}});
